#!/usr/bin/env bash
# -----------------------------------------------------------------------------
# Minimal developer setup script (Ubuntu / KDE neon / Debian-based)
#
# - Updates system
# - Installs base packages: curl, git, Python3 + pip, Node.js LTS, Lazygit
# - Installs Neovim v0.10.x (stable PPA: ppa:neovim-ppa/stable)
#
# Run with: sudo bash setup.sh
# -----------------------------------------------------------------------------

set -euo pipefail
export DEBIAN_FRONTEND=noninteractive

# --- helpers ----------------------------------------------------------------
log() { echo -e "\033[1;32m[INFO]\033[0m $*"; }

# --- system update ----------------------------------------------------------
log "Updating package lists and upgrading..."
apt-get update -y
apt-get dist-upgrade -y

# --- base packages ----------------------------------------------------------
log "Installing basic tools..."
apt-get install -y curl wget git build-essential ca-certificates gnupg lsb-release software-properties-common

# --- Python -----------------------------------------------------------------
if ! command -v python3 >/dev/null 2>&1; then
  apt-get install -y python3 python3-venv python3-pip
fi
log "Python: $(python3 --version)"

if ! command -v pip3 >/dev/null 2>&1; then
  apt-get install -y python3-pip
fi
log "Pip: $(pip3 --version)"

# --- Node.js (NodeSource LTS) -----------------------------------------------
if ! command -v node >/dev/null 2>&1; then
  log "Installing Node.js LTS..."
  curl -fsSL https://deb.nodesource.com/setup_lts.x | bash -
  apt-get install -y nodejs
fi
log "Node: $(node -v), npm: $(npm -v)"

# --- Lazygit (latest release) ----------------------------------------------
if ! command -v lazygit >/dev/null 2>&1; then
  log "Installing Lazygit..."
  tmp="$(mktemp -d)"; trap 'rm -rf "$tmp"' EXIT
  ver="$(curl -fsSL https://api.github.com/repos/jesseduffield/lazygit/releases/latest \
         | grep -Po '"tag_name":\s*"\K[^"]+')"
  curl -fsSL -o "$tmp/lg.tgz" \
    "https://github.com/jesseduffield/lazygit/releases/download/${ver}/lazygit_${ver#v}_Linux_x86_64.tar.gz"
  tar -C "$tmp" -xf "$tmp/lg.tgz" lazygit
  install "$tmp/lazygit" /usr/local/bin/lazygit
fi
log "Lazygit: $(lazygit --version | head -n1)"

# --- Neovim (stable PPA) ----------------------------------------------------
if ! command -v nvim >/dev/null 2>&1; then
  log "Installing Neovim (stable PPA)..."
  sudo apt-get update && sudo apt-get install -y snapd
  sudo snap install nvim --classic
  nvim --version | head -n1
fi
log "Neovim: $(nvim --version | head -n1)"

# --- done -------------------------------------------------------------------
log "Setup complete! Tools installed: Python, Node.js, npm, Lazygit, Neovim (stable)."
